---
title: WeakMap and WeakSet(å¼±æ˜ å°„å’Œå¼±é›†åˆ)
date: 2020-12-12 09:42:41
permalink: /pages/cbbddb/
categories:
  - ã€ŠçŽ°ä»£JavaScriptã€‹æ•™ç¨‹
  - æ•°æ®ç±»åž‹
tags: 
  - çŽ°ä»£JavaScript
author: 
  name: CD_wOw
  link: https://github.com/caidix
---

`JavaScript` å¼•æ“Žåœ¨å€¼å¯è®¿é—®ï¼ˆå¹¶å¯èƒ½è¢«ä½¿ç”¨ï¼‰æ—¶å°†å…¶å­˜å‚¨åœ¨å†…å­˜ä¸­ã€‚

ä¾‹å¦‚:

```js
let john = { name: "John" };

// è¯¥å¯¹è±¡èƒ½è¢«è®¿é—®ï¼Œjohn æ˜¯å®ƒçš„å¼•ç”¨

// è¦†ç›–å¼•ç”¨
john = null;

// è¯¥å¯¹è±¡å°†ä¼šè¢«ä»Žå†…å­˜ä¸­æ¸…é™¤
```

é€šå¸¸ï¼Œå½“å¯¹è±¡ã€æ•°ç»„è¿™ç±»æ•°æ®ç»“æž„åœ¨å†…å­˜ä¸­æ—¶ï¼Œå®ƒä»¬çš„å­å…ƒç´ ï¼Œå¦‚å¯¹è±¡çš„å±žæ€§ã€æ•°ç»„çš„å…ƒç´ éƒ½æ˜¯å¯ä»¥è®¿é—®çš„ã€‚

ä¾‹å¦‚ï¼Œå¦‚æžœæŠŠä¸€ä¸ªå¯¹è±¡æ”¾å…¥åˆ°æ•°ç»„ä¸­ï¼Œé‚£ä¹ˆåªè¦è¿™ä¸ªæ•°ç»„å­˜åœ¨ï¼Œé‚£ä¹ˆè¿™ä¸ªå¯¹è±¡ä¹Ÿå°±å­˜åœ¨ï¼Œå³ä½¿æ²¡æœ‰å…¶ä»–å¯¹è¯¥å¯¹è±¡çš„å¼•ç”¨ã€‚

å°±åƒè¿™æ ·:

```js
let john = { name: "John" };

let array = [ john ];

john = null; // è¦†ç›–å¼•ç”¨

// å‰é¢ç”± john æ‰€å¼•ç”¨çš„é‚£ä¸ªå¯¹è±¡è¢«å­˜å‚¨åœ¨äº† array ä¸­
// æ‰€ä»¥å®ƒä¸ä¼šè¢«åžƒåœ¾å›žæ”¶æœºåˆ¶å›žæ”¶
```

ç±»ä¼¼çš„ï¼Œå¦‚æžœæˆ‘ä»¬ä½¿ç”¨å¯¹è±¡ä½œä¸ºå¸¸è§„ `Map` çš„é”®ï¼Œé‚£ä¹ˆå½“ `Map` å­˜åœ¨æ—¶ï¼Œè¯¥å¯¹è±¡ä¹Ÿå°†å­˜åœ¨ã€‚å®ƒä¼šå ç”¨å†…å­˜ï¼Œå¹¶ä¸”åº”è¯¥ä¸ä¼šè¢«ï¼ˆåžƒåœ¾å›žæ”¶æœºåˆ¶ï¼‰å›žæ”¶ã€‚

ä¾‹å¦‚ï¼š

```javascript
let john = { name: "John" };

let map = new Map();
map.set(john, "...");

john = null; // è¦†ç›–å¼•ç”¨

// john è¢«å­˜å‚¨åœ¨äº† map ä¸­ï¼Œ
// æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ map.keys() æ¥èŽ·å–å®ƒ
```

`WeakMap` åœ¨è¿™æ–¹é¢æœ‰ç€æ ¹æœ¬ä¸Šçš„ä¸åŒã€‚å®ƒä¸ä¼šé˜»æ­¢åžƒåœ¾å›žæ”¶æœºåˆ¶å¯¹ä½œä¸ºé”®çš„å¯¹è±¡ï¼ˆ`key object`ï¼‰çš„å›žæ”¶ã€‚

è®©æˆ‘ä»¬é€šè¿‡ä¾‹å­æ¥çœ‹çœ‹è¿™æŒ‡çš„åˆ°åº•æ˜¯ä»€ä¹ˆã€‚

## `WeakMap`

`WeakMap` å’Œ `Map` çš„ç¬¬ä¸€ä¸ªä¸åŒç‚¹å°±æ˜¯ï¼Œ`WeakMap` çš„é”®å¿…é¡»æ˜¯å¯¹è±¡ï¼Œä¸èƒ½æ˜¯åŽŸå§‹å€¼ï¼š

> `vue3.x`ç³»åˆ—`hash`è¡¨å’Œä¾èµ–æ”¶é›†ï¼Œå¯æŸ¥çœ‹[æºç ](https://github.com/vuejs/vue-next)

```js
let weakMap = new WeakMap();

let obj = {};

weakMap.set(obj, "ok"); // æ­£å¸¸å·¥ä½œï¼ˆä»¥å¯¹è±¡ä½œä¸ºé”®ï¼‰

// ä¸èƒ½ä½¿ç”¨å­—ç¬¦ä¸²ä½œä¸ºé”®
weakMap.set("test", "Whoops"); // Errorï¼Œå› ä¸º "test" ä¸æ˜¯ä¸€ä¸ªå¯¹è±¡
```

çŽ°åœ¨ï¼Œå¦‚æžœæˆ‘ä»¬åœ¨ `weakMap` ä¸­ä½¿ç”¨ä¸€ä¸ªå¯¹è±¡ä½œä¸ºé”®ï¼Œå¹¶ä¸”æ²¡æœ‰å…¶ä»–å¯¹è¿™ä¸ªå¯¹è±¡çš„å¼•ç”¨ â€”â€” è¯¥å¯¹è±¡å°†ä¼šè¢«ä»Žå†…å­˜ï¼ˆå’Œ`map`ï¼‰ä¸­è‡ªåŠ¨æ¸…é™¤ã€‚

```js
let john = { name: "John" };

let weakMap = new WeakMap();
weakMap.set(john, "...");

john = null; // è¦†ç›–å¼•ç”¨

// john è¢«ä»Žå†…å­˜ä¸­åˆ é™¤äº†ï¼
```

ä¸Žä¸Šé¢å¸¸è§„çš„ `Map` çš„ä¾‹å­ç›¸æ¯”ï¼ŒçŽ°åœ¨å¦‚æžœ `john` ä»…ä»…æ˜¯ä½œä¸º `WeakMap` çš„é”®è€Œå­˜åœ¨ â€”â€” å®ƒå°†ä¼šè¢«ä»Ž mapï¼ˆå’Œå†…å­˜ï¼‰ä¸­è‡ªåŠ¨åˆ é™¤ã€‚

`WeakMap` ä¸æ”¯æŒè¿­ä»£ä»¥åŠ `keys()`ï¼Œ`values()` å’Œ `entries()` æ–¹æ³•ã€‚æ‰€ä»¥æ²¡æœ‰åŠžæ³•èŽ·å– `WeakMap` çš„æ‰€æœ‰é”®æˆ–å€¼ã€‚

`WeakMap` åªæœ‰ä»¥ä¸‹çš„æ–¹æ³•ï¼š

- `weakMap.get(key)`
- `weakMap.set(key, value)`
- `weakMap.delete(key)`
- `weakMap.has(key)`

ä¸ºä»€ä¹ˆä¼šæœ‰è¿™ç§é™åˆ¶å‘¢ï¼Ÿè¿™æ˜¯æŠ€æœ¯çš„åŽŸå› ã€‚å¦‚æžœä¸€ä¸ªå¯¹è±¡ä¸¢å¤±äº†å…¶å®ƒæ‰€æœ‰å¼•ç”¨ï¼ˆå°±åƒä¸Šé¢ç¤ºä¾‹ä¸­çš„ `john`ï¼‰ï¼Œé‚£ä¹ˆå®ƒå°±ä¼šè¢«åžƒåœ¾å›žæ”¶æœºåˆ¶è‡ªåŠ¨å›žæ”¶ã€‚ä½†æ˜¯åœ¨ä»ŽæŠ€æœ¯çš„è§’åº¦å¹¶ä¸èƒ½å‡†ç¡®çŸ¥é“ **ä½•æ—¶ä¼šè¢«å›žæ”¶**ã€‚

è¿™äº›éƒ½æ˜¯ç”± JavaScript å¼•æ“Žå†³å®šçš„ã€‚JavaScript å¼•æ“Žå¯èƒ½ä¼šé€‰æ‹©ç«‹å³æ‰§è¡Œå†…å­˜æ¸…ç†ï¼Œå¦‚æžœçŽ°åœ¨æ­£åœ¨å‘ç”Ÿå¾ˆå¤šåˆ é™¤æ“ä½œï¼Œé‚£ä¹ˆ JavaScript å¼•æ“Žå¯èƒ½å°±ä¼šé€‰æ‹©ç­‰ä¸€ç­‰ï¼Œç¨åŽå†è¿›è¡Œå†…å­˜æ¸…ç†ã€‚å› æ­¤ï¼Œä»ŽæŠ€æœ¯ä¸Šè®²ï¼Œ`WeakMap` çš„å½“å‰å…ƒç´ çš„æ•°é‡æ˜¯æœªçŸ¥çš„ã€‚JavaScript å¼•æ“Žå¯èƒ½æ¸…ç†äº†å…¶ä¸­çš„åžƒåœ¾ï¼Œå¯èƒ½æ²¡æ¸…ç†ï¼Œä¹Ÿå¯èƒ½æ¸…ç†äº†ä¸€éƒ¨åˆ†ã€‚å› æ­¤ï¼Œæš‚ä¸æ”¯æŒè®¿é—® `WeakMap` çš„æ‰€æœ‰é”®/å€¼çš„æ–¹æ³•ã€‚

é‚£ä¹ˆï¼Œåœ¨å“ªé‡Œæˆ‘ä»¬ä¼šéœ€è¦è¿™æ ·çš„æ•°æ®ç»“æž„å‘¢ï¼Ÿ

## ä½¿ç”¨æ¡ˆä¾‹ï¼šé¢å¤–çš„æ•°æ®

`WeakMap` çš„ä¸»è¦åº”ç”¨åœºæ™¯æ˜¯ **é¢å¤–æ•°æ®çš„å­˜å‚¨**ã€‚

å‡å¦‚æˆ‘ä»¬æ­£åœ¨å¤„ç†ä¸€ä¸ªâ€œå±žäºŽâ€å¦ä¸€ä¸ªä»£ç çš„ä¸€ä¸ªå¯¹è±¡ï¼Œä¹Ÿå¯èƒ½æ˜¯ç¬¬ä¸‰æ–¹åº“ï¼Œå¹¶æƒ³å­˜å‚¨ä¸€äº›ä¸Žä¹‹ç›¸å…³çš„æ•°æ®ï¼Œé‚£ä¹ˆè¿™äº›æ•°æ®å°±åº”è¯¥ä¸Žè¿™ä¸ªå¯¹è±¡å…±å­˜äº¡ â€”â€” è¿™æ—¶å€™ `WeakMap` æ­£æ˜¯æˆ‘ä»¬æ‰€éœ€è¦çš„åˆ©å™¨ã€‚

æˆ‘ä»¬å°†è¿™äº›æ•°æ®æ”¾åˆ° `WeakMap` ä¸­ï¼Œå¹¶ä½¿ç”¨è¯¥å¯¹è±¡ä½œä¸ºè¿™äº›æ•°æ®çš„é”®ï¼Œé‚£ä¹ˆå½“è¯¥å¯¹è±¡è¢«åžƒåœ¾å›žæ”¶æœºåˆ¶å›žæ”¶åŽï¼Œè¿™äº›æ•°æ®ä¹Ÿä¼šè¢«è‡ªåŠ¨æ¸…é™¤ã€‚

```js
weakMap.set(john, "secret documents");
// å¦‚æžœ john æ¶ˆå¤±ï¼Œsecret documents å°†ä¼šè¢«è‡ªåŠ¨æ¸…é™¤
```

è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ã€‚

ä¾‹å¦‚ï¼Œæˆ‘ä»¬æœ‰ç”¨äºŽå¤„ç†ç”¨æˆ·è®¿é—®è®¡æ•°çš„ä»£ç ã€‚æ”¶é›†åˆ°çš„ä¿¡æ¯è¢«å­˜å‚¨åœ¨ map ä¸­ï¼šä¸€ä¸ªç”¨æˆ·å¯¹è±¡ä½œä¸ºé”®ï¼Œå…¶è®¿é—®æ¬¡æ•°ä¸ºå€¼ã€‚å½“ä¸€ä¸ªç”¨æˆ·ç¦»å¼€æ—¶ï¼ˆè¯¥ç”¨æˆ·å¯¹è±¡å°†è¢«åžƒåœ¾å›žæ”¶æœºåˆ¶å›žæ”¶ï¼‰ï¼Œè¿™æ—¶æˆ‘ä»¬å°±ä¸å†éœ€è¦ä»–çš„è®¿é—®æ¬¡æ•°äº†ã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨ `Map` çš„è®¡æ•°å‡½æ•°çš„ä¾‹å­ï¼š

```js
// ðŸ“ visitsCount.js
let visitsCountMap = new Map(); // map: user => visits count

// é€’å¢žç”¨æˆ·æ¥è®¿æ¬¡æ•°
function countUser(user) {
  let count = visitsCountMap.get(user) || 0;
  visitsCountMap.set(user, count + 1);
} 
```

ä¸‹é¢æ˜¯å…¶ä»–éƒ¨åˆ†çš„ä»£ç ï¼Œå¯èƒ½æ˜¯ä½¿ç”¨å®ƒçš„å…¶å®ƒä»£ç ï¼š

```js
// ðŸ“ main.js
let john = { name: "John" };

countUser(john); // count his visits

// ä¸ä¹…ä¹‹åŽï¼Œjohn ç¦»å¼€äº†
john = null;
```

çŽ°åœ¨ `john` è¿™ä¸ªå¯¹è±¡åº”è¯¥è¢«åžƒåœ¾å›žæ”¶ï¼Œä½†ä»–ä»åœ¨å†…å­˜ä¸­ï¼Œå› ä¸ºå®ƒæ˜¯ `visitsCountMap` ä¸­çš„ä¸€ä¸ªé”®ã€‚

å½“æˆ‘ä»¬ç§»é™¤ç”¨æˆ·æ—¶ï¼Œæˆ‘ä»¬éœ€è¦æ¸…ç† `visitsCountMap`ï¼Œå¦åˆ™å®ƒå°†åœ¨å†…å­˜ä¸­æ— é™å¢žå¤§ã€‚åœ¨å¤æ‚çš„æž¶æž„ä¸­ï¼Œè¿™ç§æ¸…ç†ä¼šæˆä¸ºä¸€é¡¹ç¹é‡çš„ä»»åŠ¡ã€‚

æˆ‘ä»¬å¯ä»¥é€šè¿‡ä½¿ç”¨ `WeakMap` æ¥é¿å…è¿™æ ·çš„é—®é¢˜ï¼š

```js
// ðŸ“ visitsCount.js
let visitsCountMap = new WeakMap(); // weakmap: user => visits count

// é€’å¢žç”¨æˆ·æ¥è®¿æ¬¡æ•°
function countUser(user) {
  let count = visitsCountMap.get(user) || 0;
  visitsCountMap.set(user, count + 1);
}
```

çŽ°åœ¨æˆ‘ä»¬ä¸éœ€è¦åŽ»æ¸…ç† `visitsCountMap` äº†ã€‚å½“ `john` å¯¹è±¡å˜æˆä¸å¯è®¿é—®æ—¶ï¼Œå³ä¾¿å®ƒæ˜¯ `WeakMap` é‡Œçš„ä¸€ä¸ªé”®ï¼Œå®ƒä¹Ÿä¼šè¿žåŒå®ƒä½œä¸º `WeakMap` é‡Œçš„é”®æ‰€å¯¹åº”çš„ä¿¡æ¯ä¸€åŒè¢«ä»Žå†…å­˜ä¸­åˆ é™¤ã€‚

## ä½¿ç”¨æ¡ˆä¾‹ï¼šç¼“å­˜

å¦å¤–ä¸€ä¸ªæ™®éçš„ä¾‹å­æ˜¯ç¼“å­˜ï¼šå½“ä¸€ä¸ªå‡½æ•°çš„ç»“æžœéœ€è¦è¢«è®°ä½ï¼ˆâ€œç¼“å­˜â€ï¼‰ï¼Œè¿™æ ·åœ¨åŽç»­çš„å¯¹åŒä¸€ä¸ªå¯¹è±¡çš„è°ƒç”¨æ—¶ï¼Œå°±å¯ä»¥é‡ç”¨è¿™ä¸ªè¢«ç¼“å­˜çš„ç»“æžœã€‚

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `Map` æ¥å­˜å‚¨ç»“æžœï¼Œå°±åƒè¿™æ ·ï¼š

```js
// ðŸ“ cache.js
let cache = new Map();

// è®¡ç®—å¹¶è®°ä½ç»“æžœ
function process(obj) {
  if (!cache.has(obj)) {
    let result = /* calculations of the result for */ obj;

    cache.set(obj, result);
  }

  return cache.get(obj);
}

// çŽ°åœ¨æˆ‘ä»¬åœ¨å…¶å®ƒæ–‡ä»¶ä¸­ä½¿ç”¨ process()

// ðŸ“ main.js
let obj = {/* å‡è®¾æˆ‘ä»¬æœ‰ä¸ªå¯¹è±¡ */};

let result1 = process(obj); // è®¡ç®—å®Œæˆ

// â€¦â€¦ç¨åŽï¼Œæ¥è‡ªä»£ç çš„å¦å¤–ä¸€ä¸ªåœ°æ–¹â€¦â€¦
let result2 = process(obj); // å–è‡ªç¼“å­˜çš„è¢«è®°å¿†çš„ç»“æžœ

// â€¦â€¦ç¨åŽï¼Œæˆ‘ä»¬ä¸å†éœ€è¦è¿™ä¸ªå¯¹è±¡æ—¶ï¼š
obj = null;

alert(cache.size); // 1ï¼ˆå•Šï¼è¯¥å¯¹è±¡ä¾ç„¶åœ¨ cache ä¸­ï¼Œå¹¶å æ®ç€å†…å­˜ï¼ï¼‰
```

å¯¹äºŽå¤šæ¬¡è°ƒç”¨åŒä¸€ä¸ªå¯¹è±¡ï¼Œå®ƒåªéœ€åœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶è®¡ç®—å‡ºç»“æžœï¼Œä¹‹åŽçš„è°ƒç”¨å¯ä»¥ç›´æŽ¥ä»Ž `cache` ä¸­èŽ·å–ã€‚è¿™æ ·åšçš„ç¼ºç‚¹æ˜¯ï¼Œå½“æˆ‘ä»¬ä¸å†éœ€è¦è¿™ä¸ªå¯¹è±¡çš„æ—¶å€™éœ€è¦æ¸…ç† `cache`ã€‚

å¦‚æžœæˆ‘ä»¬ç”¨ `WeakMap` æ›¿ä»£ `Map`ï¼Œè¿™ä¸ªé—®é¢˜ä¾¿ä¼šæ¶ˆå¤±ï¼šå½“å¯¹è±¡è¢«åžƒåœ¾å›žæ”¶æ—¶ï¼Œå¯¹åº”çš„ç¼“å­˜çš„ç»“æžœä¹Ÿä¼šè¢«è‡ªåŠ¨åœ°ä»Žå†…å­˜ä¸­æ¸…é™¤ã€‚

```js
// ðŸ“ cache.js
let cache = new WeakMap();

// è®¡ç®—å¹¶è®°ç»“æžœ
function process(obj) {
  if (!cache.has(obj)) {
    let result = /* calculate the result for */ obj;

    cache.set(obj, result);
  }

  return cache.get(obj);
}

// ðŸ“ main.js
let obj = {/* some object */};

let result1 = process(obj);
let result2 = process(obj);

// â€¦â€¦ç¨åŽï¼Œæˆ‘ä»¬ä¸å†éœ€è¦è¿™ä¸ªå¯¹è±¡æ—¶ï¼š
obj = null;

// æ— æ³•èŽ·å– cache.sizeï¼Œå› ä¸ºå®ƒæ˜¯ä¸€ä¸ª WeakMapï¼Œ
// è¦ä¹ˆæ˜¯ 0ï¼Œæˆ–å³å°†å˜ä¸º 0
// å½“ obj è¢«åžƒåœ¾å›žæ”¶ï¼Œç¼“å­˜çš„æ•°æ®ä¹Ÿä¼šè¢«æ¸…é™¤
```

## `WeakSet`

`WeakSet` çš„è¡¨çŽ°ç±»ä¼¼ï¼š

- ä¸Ž `Set` ç±»ä¼¼ï¼Œä½†æ˜¯æˆ‘ä»¬åªèƒ½å‘ `WeakSet` æ·»åŠ å¯¹è±¡ï¼ˆè€Œä¸èƒ½æ˜¯åŽŸå§‹å€¼ï¼‰ã€‚
- å¯¹è±¡åªæœ‰åœ¨å…¶å®ƒæŸä¸ªï¼ˆäº›ï¼‰åœ°æ–¹èƒ½è¢«è®¿é—®çš„æ—¶å€™ï¼Œæ‰èƒ½ç•™åœ¨ set ä¸­ã€‚
- è·Ÿ `Set` ä¸€æ ·ï¼Œ`WeakSet` æ”¯æŒ `add`ï¼Œ`has` å’Œ `delete` æ–¹æ³•ï¼Œä½†ä¸æ”¯æŒ `size` å’Œ `keys()`ï¼Œå¹¶ä¸”ä¸å¯è¿­ä»£ã€‚

å˜â€œå¼±ï¼ˆweakï¼‰â€çš„åŒæ—¶ï¼Œå®ƒä¹Ÿå¯ä»¥ä½œä¸ºé¢å¤–çš„å­˜å‚¨ç©ºé—´ã€‚ä½†å¹¶éžé’ˆå¯¹ä»»æ„æ•°æ®ï¼Œè€Œæ˜¯é’ˆå¯¹â€œæ˜¯/å¦â€çš„äº‹å®žã€‚`WeakSet` çš„å…ƒç´ å¯èƒ½ä»£è¡¨ç€æœ‰å…³è¯¥å¯¹è±¡çš„æŸäº›ä¿¡æ¯ã€‚

ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥å°†ç”¨æˆ·æ·»åŠ åˆ° `WeakSet` ä¸­ï¼Œä»¥è¿½è¸ªè®¿é—®è¿‡æˆ‘ä»¬ç½‘ç«™çš„ç”¨æˆ·ï¼š

```js
let visitedSet = new WeakSet();

let john = { name: "John" };
let pete = { name: "Pete" };
let mary = { name: "Mary" };

visitedSet.add(john); // John è®¿é—®äº†æˆ‘ä»¬
visitedSet.add(pete); // ç„¶åŽæ˜¯ Pete
visitedSet.add(john); // John å†æ¬¡è®¿é—®

// visitedSet çŽ°åœ¨æœ‰ä¸¤ä¸ªç”¨æˆ·äº†

// æ£€æŸ¥ John æ˜¯å¦æ¥è®¿è¿‡ï¼Ÿ
alert(visitedSet.has(john)); // true

// æ£€æŸ¥ Mary æ˜¯å¦æ¥è®¿è¿‡ï¼Ÿ
alert(visitedSet.has(mary)); // false

john = null;

// visitedSet å°†è¢«è‡ªåŠ¨æ¸…ç†
```

`WeakMap` å’Œ `WeakSet` æœ€æ˜Žæ˜¾çš„å±€é™æ€§å°±æ˜¯ä¸èƒ½è¿­ä»£ï¼Œå¹¶ä¸”æ— æ³•èŽ·å–æ‰€æœ‰å½“å‰å†…å®¹ã€‚é‚£æ ·å¯èƒ½ä¼šé€ æˆä¸ä¾¿ï¼Œä½†æ˜¯å¹¶ä¸ä¼šé˜»æ­¢ `WeakMap/WeakSet` å®Œæˆå…¶ä¸»è¦å·¥ä½œ â€” æˆä¸ºåœ¨å…¶å®ƒåœ°æ–¹ç®¡ç†/å­˜å‚¨â€œé¢å¤–â€çš„å¯¹è±¡æ•°æ®ã€‚

## æ€»ç»“

`WeakMap` æ˜¯ç±»ä¼¼äºŽ `Map` çš„é›†åˆï¼Œå®ƒä»…å…è®¸å¯¹è±¡ä½œä¸ºé”®ï¼Œå¹¶ä¸”ä¸€æ—¦é€šè¿‡å…¶ä»–æ–¹å¼æ— æ³•è®¿é—®å®ƒä»¬ï¼Œä¾¿ä¼šå°†å®ƒä»¬ä¸Žå…¶å…³è”å€¼ä¸€åŒåˆ é™¤ã€‚

`WeakSet` æ˜¯ç±»ä¼¼äºŽ `Set` çš„é›†åˆï¼Œå®ƒä»…å­˜å‚¨å¯¹è±¡ï¼Œå¹¶ä¸”ä¸€æ—¦é€šè¿‡å…¶ä»–æ–¹å¼æ— æ³•è®¿é—®å®ƒä»¬ï¼Œä¾¿ä¼šå°†å…¶åˆ é™¤ã€‚

å®ƒä»¬éƒ½ä¸æ”¯æŒå¼•ç”¨æ‰€æœ‰é”®æˆ–å…¶è®¡æ•°çš„æ–¹æ³•å’Œå±žæ€§ã€‚ä»…å…è®¸å•ä¸ªæ“ä½œã€‚

`WeakMap` å’Œ `WeakSet` è¢«ç”¨ä½œâ€œä¸»è¦â€å¯¹è±¡å­˜å‚¨ä¹‹å¤–çš„â€œè¾…åŠ©â€æ•°æ®ç»“æž„ã€‚ä¸€æ—¦å°†å¯¹è±¡ä»Žä¸»å­˜å‚¨å™¨ä¸­åˆ é™¤ï¼Œå¦‚æžœè¯¥å¯¹è±¡ä»…è¢«ç”¨ä½œ `WeakMap` æˆ– `WeakSet` çš„é”®ï¼Œé‚£ä¹ˆå®ƒå°†è¢«è‡ªåŠ¨æ¸…é™¤ã€‚

## ä»»åŠ¡

### å­˜å‚¨ "unread" æ ‡è¯†

è¿™é‡Œæœ‰ä¸€ä¸ª messages æ•°ç»„ï¼š

```js
let messages = [
  {text: "Hello", from: "John"},
  {text: "How goes?", from: "John"},
  {text: "See you soon", from: "Alice"}
];
```

ä½ çš„ä»£ç å¯ä»¥è®¿é—®å®ƒï¼Œä½†æ˜¯ message æ˜¯ç”±å…¶ä»–äººçš„ä»£ç ç®¡ç†çš„ã€‚è¯¥ä»£ç ä¼šå®šæœŸæ·»åŠ æ–°æ¶ˆæ¯ï¼Œåˆ é™¤æ—§æ¶ˆæ¯ï¼Œä½†æ˜¯ä½ ä¸çŸ¥é“è¿™äº›æ“ä½œç¡®åˆ‡çš„å‘ç”Ÿæ—¶é—´ã€‚

çŽ°åœ¨ï¼Œä½ åº”è¯¥ä½¿ç”¨ä»€ä¹ˆæ•°æ®ç»“æž„æ¥ä¿å­˜å…³äºŽæ¶ˆæ¯â€œæ˜¯å¦å·²è¯»â€çš„ä¿¡æ¯ï¼Ÿè¯¥ç»“æž„å¿…é¡»å¾ˆé€‚åˆå¯¹ç»™å®šçš„ message å¯¹è±¡ç»™å‡ºâ€œå®ƒè¯»äº†å—ï¼Ÿâ€çš„ç­”æ¡ˆã€‚

`P.S`. å½“ä¸€ä¸ªæ¶ˆæ¯è¢«ä»Ž `messages` ä¸­åˆ é™¤åŽï¼Œå®ƒåº”è¯¥ä¹Ÿä»Žä½ çš„æ•°æ®ç»“æž„ä¸­æ¶ˆå¤±ã€‚

`P.S`. æˆ‘ä»¬ä¸èƒ½ä¿®æ”¹ message å¯¹è±¡ï¼Œä¾‹å¦‚å‘å…¶æ·»åŠ æˆ‘ä»¬çš„å±žæ€§ã€‚å› ä¸ºå®ƒä»¬æ˜¯ç”±å…¶ä»–äººçš„ä»£ç ç®¡ç†çš„ï¼Œæˆ‘ä»¬ä¿®æ”¹è¯¥æ•°æ®å¯èƒ½ä¼šå¯¼è‡´ä¸å¥½çš„åŽæžœã€‚

> è®©æˆ‘ä»¬å°†å·²è¯»æ¶ˆæ¯å­˜å‚¨åœ¨ `WeakSet` ä¸­ï¼š
>
> ```javascript
> let messages = [
>   {text: "Hello", from: "John"},
>   {text: "How goes?", from: "John"},
>   {text: "See you soon", from: "Alice"}
> ];
> 
> let readMessages = new WeakSet();
> 
> // ä¸¤ä¸ªæ¶ˆæ¯å·²è¯»
> readMessages.add(messages[0]);
> readMessages.add(messages[1]);
> // readMessages åŒ…å«ä¸¤ä¸ªå…ƒç´ 
> 
> // â€¦â€¦è®©æˆ‘ä»¬å†è¯»ä¸€éç¬¬ä¸€æ¡æ¶ˆæ¯ï¼
> readMessages.add(messages[0]);
> // readMessages ä»ç„¶æœ‰ä¸¤ä¸ªä¸é‡å¤çš„å…ƒç´ 
> 
> // å›žç­”ï¼šmessage[0] å·²è¯»ï¼Ÿ
> alert("Read message 0: " + readMessages.has(messages[0])); // true
> 
> messages.shift();
> // çŽ°åœ¨ readMessages æœ‰ä¸€ä¸ªå…ƒç´ ï¼ˆæŠ€æœ¯ä¸Šæ¥è®²ï¼Œå†…å­˜å¯èƒ½ç¨åŽæ‰ä¼šè¢«æ¸…ç†ï¼‰
> ```
>
> `WeakSet` å…è®¸å­˜å‚¨ä¸€ç³»åˆ—çš„æ¶ˆæ¯ï¼Œå¹¶ä¸”å¾ˆå®¹æ˜“å°±èƒ½æ£€æŸ¥å®ƒæ˜¯å¦åŒ…å«æŸä¸ªæ¶ˆæ¯ã€‚
>
> å®ƒä¼šè‡ªåŠ¨æ¸…ç†è‡ªèº«ã€‚ä»£ä»·æ˜¯ï¼Œæˆ‘ä»¬ä¸èƒ½å¯¹å®ƒè¿›è¡Œè¿­ä»£ï¼Œä¹Ÿä¸èƒ½ç›´æŽ¥ä»Žä¸­èŽ·å–â€œæ‰€æœ‰å·²è¯»æ¶ˆæ¯â€ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡éåŽ†æ‰€æœ‰æ¶ˆæ¯ï¼Œç„¶åŽæ‰¾å‡ºå­˜åœ¨äºŽ set çš„é‚£äº›æ¶ˆæ¯æ¥å®Œæˆè¿™ä¸ªåŠŸèƒ½ã€‚
>
> å¦ä¸€ç§ä¸åŒçš„è§£å†³æ–¹æ¡ˆå¯ä»¥æ˜¯ï¼Œåœ¨è¯»å–æ¶ˆæ¯åŽå‘æ¶ˆæ¯æ·»åŠ è¯¸å¦‚ `message.isRead=true` ä¹‹ç±»çš„å±žæ€§ã€‚ç”±äºŽ `messages` å¯¹è±¡æ˜¯ç”±å¦ä¸€ä¸ªä»£ç ç®¡ç†çš„ï¼Œå› æ­¤é€šå¸¸ä¸å»ºè®®è¿™æ ·åšï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ symbol å±žæ€§æ¥é¿å…å†²çªã€‚
>
> åƒè¿™æ ·ï¼š
>
> ```javascript
> // symbol å±žæ€§ä»…å¯¹äºŽæˆ‘ä»¬çš„ä»£ç æ˜¯å·²çŸ¥çš„
> let isRead = Symbol("isRead");
> messages[0][isRead] = true;
> ```
>
> çŽ°åœ¨ï¼Œç¬¬ä¸‰æ–¹ä»£ç å¯èƒ½çœ‹ä¸åˆ°æˆ‘ä»¬çš„é¢å¤–å±žæ€§ã€‚
>
> å°½ç®¡ symbol å¯ä»¥é™ä½Žå‡ºçŽ°é—®é¢˜çš„å¯èƒ½æ€§ï¼Œä½†ä»Žæž¶æž„çš„è§’åº¦æ¥çœ‹ï¼Œè¿˜æ˜¯ä½¿ç”¨ `WeakSet` æ›´å¥½ã€‚

### ä¿å­˜é˜…è¯»æ—¥æœŸ

è¿™å„¿æœ‰ä¸€ä¸ªå’Œ [ä¸Šä¸€ä¸ªä»»åŠ¡](https://zh.javascript.info/task/recipients-read) ç±»ä¼¼çš„ `messages` æ•°ç»„ã€‚åœºæ™¯ä¹Ÿç›¸ä¼¼ã€‚

```javascript
let messages = [
  {text: "Hello", from: "John"},
  {text: "How goes?", from: "John"},
  {text: "See you soon", from: "Alice"}
];
```

çŽ°åœ¨çš„é—®é¢˜æ˜¯ï¼šä½ å»ºè®®é‡‡ç”¨ä»€ä¹ˆæ•°æ®ç»“æž„æ¥ä¿å­˜ä¿¡æ¯ï¼šâ€œæ¶ˆæ¯æ˜¯ä»€ä¹ˆæ—¶å€™è¢«é˜…è¯»çš„ï¼Ÿâ€ã€‚

åœ¨å‰ä¸€ä¸ªä»»åŠ¡ä¸­æˆ‘ä»¬åªéœ€è¦ä¿å­˜â€œæ˜¯/å¦â€ã€‚çŽ°åœ¨æˆ‘ä»¬éœ€è¦ä¿å­˜æ—¥æœŸï¼Œå¹¶ä¸”å®ƒåº”è¯¥åœ¨æ¶ˆæ¯è¢«åžƒåœ¾å›žæ”¶æ—¶ä¹Ÿè¢«ä»Žå†…å­˜ä¸­æ¸…é™¤ã€‚

`P.S`. æ—¥æœŸå¯ä»¥å­˜å‚¨ä¸ºå†…å»ºçš„ `Date` ç±»çš„å¯¹è±¡ï¼Œç¨åŽæˆ‘ä»¬å°†è¿›è¡Œä»‹ç»ã€‚

> æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `WeakMap` ä¿å­˜æ—¥æœŸï¼š
>
> ```javascript
> let messages = [
>   {text: "Hello", from: "John"},
>   {text: "How goes?", from: "John"},
>   {text: "See you soon", from: "Alice"}
> ];
> 
> let readMap = new WeakMap();
> 
> readMap.set(messages[0], new Date(2017, 1, 1));
> // æˆ‘ä»¬ç¨åŽå°†å­¦ä¹  Date å¯¹è±¡
> ```