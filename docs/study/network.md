# 网络

## 从输入域名到渲染出页面都经历了什么
### 浏览器的多进程架构
在chrome中，一个页面 浏览器就会为其分配一个进程，每个页面的进程相对独立，单独页面的崩溃并不会影响到其他页面的正常运行。
1. 浏览器进程:负责浏览器的用户交互、子进程管理和文件存储功能。比如tab的前进后退、处理一些不可见的底层操作如网络请求等。
2. 网络进程: 网络进程是面向渲染进程和浏览器进程等提供网络下载功能。
3. 渲染进程: 渲染进程的主要职责是把从网络下载的 HTML、JavaScript、CSS、图片等资源解析为可以显示和交互的页面。因为渲染进程所有的内容都是通过网络获取的，会存在一些恶意代码利用浏览器漏洞对系统进行攻击，所以运行在渲染进程里面的代码是不被信任的。这也是为什么 Chrome 会让渲染进程运行在安全沙箱里，就是为了保证系统的安全。

### 网页加载的过程
- 首先，用户从浏览器进程里输入请求信息；
- 然后，网络进程发起 URL 请求；
- 服务器响应 URL 请求之后，浏览器进程就又要开始准备渲染进程了；
- 渲染进程准备好之后，需要先向渲染进程提交页面数据，我们称之为提交文档阶段；
- 渲染进程接收完文档信息之后，便开始解析页面和加载子资源，完成页面的渲染。

### 用户输入
当用户在地址栏中输入查询的关键字时， 浏览器回去根据正则规则去判断它是一个网站链接还是一个搜索内容。同时会根据输入内容是否符合url协议去将输入的链接整合成一个完整的url。

### url请求过程
- 浏览器进程会通过进程间通信（IPC）把URL请求发送给网络进程，网络进程接收到请求后，会先去查找本地缓存，如果有本地缓存资源，则直接返回资源给浏览器进程。如果没有找到，那么直接
进入网络请求流程。第一步是进行DNS域名解析，将域名的所属的IP解析出来，如果是HTTPS协议，还需要建立TLS链接。
- 当通过IP地址和服务器建立了TCP连接之后，浏览器端会构建请求行、请求头等信息，并把域名相对应的cookie等数据附加在请求头中，然后向服务器发送构建的请求信息。
- 服务器接收到请求信息后，根据请求信息生成响应数据（包括响应头、响应行、响应体等信息），并发给网络进程。网络进程接受到了响应行和 响应头后，开始解析响应头的内容。
1. 重定向：在接收到服务器返回的响应头后，网络进程开始解析响应头。 如果发现返回的状态码是301或是302，说明服务器需要浏览器重定向至其他的URL，这时候网络进程会去响应头中拿到重定向的数据Location,然后重新发起HTTP或者HTTPS请求，然后重新走url的请求过程。直到响应行的状态码是200的时候，则表示浏览器可以继续处理该请求。
2. 响应数据类型处理：当处理了跳转信息之后，浏览器会根据响应头中的Content-Type来决定如何显示响应体的内容。若返回的是字节流类型的，浏览器一般会按照下载类型来处理该需求，
该请求会被提交给下载管理器，同时结束这次请求。如果是HTML，那么浏览器则会继续进行导航流程。准备渲染进程。
3. 准备渲染进程：默认情况下，chrome会为每一个页面分配一个渲染进程，当然也有例外，如果多个页面都是相同域名下的子域名，或是不同的端口，都认为他们是同一站点。Chrome 的默认策略是，每个标签对应一个渲染进程。但如果从一个页面打开了另一个新页面，而新页面和当前页面属于同一站点的话，那么新页面会复用父页面的渲染进程。官方把这个默认策略叫 process-per-site-instance。

渲染进程准备好之后，还不能立即进入文档解析状态，因为此时的文档数据还在网络进程中，并没有提交给渲染进程，所以下一步就进入了提交文档阶段。

4. 提交文档：这里的“文档”是指 URL 请求的响应体数据。
“提交文档”的消息是由浏览器进程发出的，渲染进程接收到“提交文档”的消息后，会和网络进程建立传输数据的“管道”。
等文档数据传输完成之后，渲染进程会返回“确认提交”的消息给浏览器进程。
浏览器进程在收到“确认提交”的消息后，会更新浏览器界面状态，包括了安全状态、地址栏的 URL、前进后退的历史状态，并更新 Web 页面。
这也就解释了为什么在浏览器的地址栏里面输入了一个地址后，之前的页面没有立马消失，而是要加载一会儿才会更新页面。

到这里，一个完整的导航流程就“走”完了，这之后就要进入渲染阶段了。

5. 渲染阶段：文件解码成功后会正式开始渲染流程，先会根据 HTML 构建 DOM 树，有CSS的话会去构建 CSSOM 树。如果遇到 script 标签的话，会判断是否存在 async 或者 defer ，前者会并行进行下载并执行 JS，后者会先下载文件，然后等待 HTML 解析完成后顺序执行。
如果以上都没有，就会阻塞住渲染流程直到 JS 执行完毕。
CSSOM 树和 DOM 树构建完成后会开始生成 Render 树，这一步就是确定页面元素的布局、样式等等诸多方面的东西
在生成 Render 树的过程中，浏览器就开始调用GPU 绘制，合成图层，将内容显示在屏幕上了。