---
title: React常用自定义Hook汇总
date: 2023-01-01 00:00:00
tags:
  - JavaScript
  - React
categories:
  - React笔记
---

### UseSetState

> UseSetState: 用于方便更新 JSON 数据

```ts
import { useCallback, useState } from "react";
export type SetState<S extends Record<string, any>> = <K extends keyof S>(
  state: Pick<S, K> | null | ((prevState: Readonly<S>) => Pick<S, K> | S | null)
) => void;

const useSetState = <S extends Record<string, any>>(
  initialState: S | (() => S)
): [S, SetState<S>] => {
  const [state, setState] = useState<S>(initialState);

  const setMergeState = useCallback((patch) => {
    setState((prevState) => {
      const newState = typeof patch === "function" ? patch(prevState) : patch;

      return newState ? { ...prevState, ...newState } : prevState;
    });
  }, []);

  return [state, setMergeState];
};
```

### useUpdateEffect

> useUpdateEffect: 用于跳过组件第一次初始化时的 effect，只关注后续的 update 变化

```ts
import React, { useEffect, useRef } from "react";

const useUpdateEffect = (effect: Function, deps: any[]) => {
  const isMounted = useRef<boolean>(false);

  useEffect(() => {
    return () => {
      isMounted.current = false;
    };
  }, []);

  useEffect(() => {
    if (!isMounted.current) {
      isMounted.current = true;
    } else {
      return effect();
    }
  }, [deps]);
};
```

### 控制监听 DOM 元素

```js
export const LogContext = createContext({});

export const useLog = () => {
  /* 定义一些公共参数 */
  const message = useContext(LogContext);
  const listenDOM = useRef(null);

  /* 分清依赖关系 */
  const reportMessage = useCallback(
    function (data, type) {
      if (type === "pv") {
        // 页面浏览量上报
        console.log("组件 pv 上报", message);
      } else if (type === "click") {
        // 点击上报
        console.log("组件 click 上报", message, data);
      }
    },
    [message]
  );

  useEffect(() => {
    const handleClick = function (e) {
      reportMessage(e.target, "click");
    };
    if (listenDOM.current) {
      listenDOM.current.addEventListener("click", handleClick);
    }

    return function () {
      listenDOM.current &&
        listenDOM.current.removeEventListener("click", handleClick);
    };
  }, [reportMessage]);

  return [listenDOM, reportMessage];
};
```

使用

```js
const Home = () => {
  const [dom, reportMessage] = useLog();
  return (
    <div>
      {/* 监听内部点击 */}
      <div ref={dom}>
        <button> 按钮 1 (内部点击) </button>
        <button> 按钮 2 (内部点击) </button>
        <button> 按钮 3 (内部点击) </button>
      </div>
      {/* 外部点击 */}
      <button
        onClick={() => {
          console.log(reportMessage);
        }}
      >
        外部点击
      </button>
    </div>
  );
};
```

### 离开页面前确认

```js
import { useCallback, useEffect, useRef } from 'react'
import { useHistory } from 'react-router-dom'

export function usePromt(
    when?: boolean | (() => boolean),
    msg = '修改内容未保存，确定要关闭页面吗？'
) {
  const history = useHistory()

  const curStatus = useRef(when)
  const curMsg = useRef(msg)

  useEffect(() => {
    curStatus.current = when
  }, [when])

  useEffect(() => {
    curMsg.current = msg
  }, [msg])

  const onBeforeUnload = useCallback((event: any) => {
    if (typeof curStatus.current === 'function' && curStatus.current()) {
      event.preventDefault()
      event.returnValue = curMsg.current
    } else if (typeof curStatus.current === 'boolean' && curStatus.current) {
      event.preventDefault()
      event.returnValue = curMsg.current
    }
  }, [])

  useEffect(() => {
    const unblock = history.block(() => {
      if (
        (typeof curStatus.current === 'function' && curStatus.current()) ||
        (typeof curStatus.current === 'boolean' && curStatus.current)
      ) {
        return curMsg.current
      }
    })

    return () => unblock()
  }, [])

  useEffect(() => {
    window.addEventListener('beforeunload', onBeforeUnload)
    return () => {
      window.removeEventListener(
        'beforeunload',
        onbeforeunload as EventListenerOrEventListenerObject
      )
    }
  }, [])
}
```

使用

```js
usePromt(true);
```
